# BAISHUN Game Settings — Implementation Guide

This file extracts and summarizes the BAISHUN H5 game access documentation (from
assets/BAISHUN Game Access Documentation V1.2.8.pdf) into a concise, actionable
guide for integrating games into the app.

**Files:**
- Full extracted text: [assets/BAISHUN_game_access.txt](assets/BAISHUN_game_access.txt)

**1. WebView / JS bridge: overview**
- Communication is done via a JSBridge injected into the WebView. Data passed
  between app and H5 uses JSON strings.
- Required JS methods the app must handle (game -> app): `getConfig`, `destroy`,
  `gameRecharge`, `gameLoaded`.
- App -> game method: `walletUpdate` (call JS to notify game of currency changes).

**2. `getConfig` payload (what app must return to game JS)**
- Top-level fields (JSON):
  - `appChannel` (string) — merchant channel configured by BAISHUN.
  - `appId` (int64) — merchant app id.
  - `userId` (string) — player id.
  - `code` (string) — one-time authentication token generated by the client.
    *Important: `code` is single-use. The game server will call your backend to
    exchange `code` for `ss_token`.*
  - `roomId` (string) — may be empty if not used.
  - `gameMode` (string) — game scenario (e.g., `2` half-screen, `3` full-screen).
  - `language` (string) — language code (see Multilingual table below).
  - `gameConfig` (object):
    - `sceneMode` (int) — mode level (0 default; game-specific meanings).
    - `currencyIcon` (string) — external URL to currency icon (recommended 60x60).
  - `gsp` (int) — game official server node (e.g., 101 Singapore, 201 Dubai).

Example minimal response (JS callback invocation):
```
jsCallback({
  "appChannel":"mesh",
  "appId":88888888,
  "userId":"338426830",
  "code":"<one-time-code>",
  "roomId":"20240101",
  "gameMode":"3",
  "language":"2",
  "gameConfig":{"sceneMode":0, "currencyIcon":"https://...png"},
  "gsp":101
})
```

**3. Important backend endpoints (app server ↔ BAISHUN)**
- `POST /v1/api/get_sstoken` — exchange `code` for `ss_token` (required by BAISHUN).
- `POST /v1/api/get_user_info` — BAISHUN requests this from your server to fetch
  user display data (avatar, name, balance).
- `POST /v1/api/update_sstoken` — refresh ss_token.
- `POST /v1/api/change_balance` — game settlement; be sure to protect against
  concurrent requests (per-user locking). Key fields: `currency_diff`, `order_id`,
  `game_id`, `room_id`, `game_round_id`, `change_time_at`, `diff_msg`.
- `POST /v1/api/one_game_info` and `POST /v1/api/gamelist` — obtain game URLs,
  preview icons, versions and download URLs.
- `POST /v2/api/balance_info` — optional balance query for some game categories.

Authentication (app server ↔ BAISHUN):
- Signature: md5(signatureNonce + AppKey + timestamp) — lowercase hex 32 chars.
- Requests must include: `signature_nonce`, `timestamp`, `signature` (valid 15s).

**4. WebView settings (Android / iOS / Flutter)**
- JavaScript must be enabled (unrestricted).
- Enable DOM storage and database/app cache if available.
- Allow mixed content loading (Android Lollipop+): MIXED_CONTENT_ALWAYS_ALLOW.
- Allow universal access from file URLs (for local zip packages):
  `setAllowUniversalAccessFromFileURLs(true)` (Android) / `allowUniversalAccessFromFileURLs` (iOS).
- Allow file access and inline media playback; set media playback to not require
  a user gesture when appropriate.
- Set WebView height to the full screen; `safe_height` from BAISHUN can be used
  to size the UI properly.

Flutter specifics:
- Recommended plugin: `webview_flutter` (example uses ^4.4.2).
- Android: add `INTERNET` permission and consider `android:usesCleartextTraffic="true"`
  for HTTP test URLs.
- For full JSBridge compatibility on Android, either extend the platform WebView
  to add a `NativeBridge` (JavascriptInterface) and an `EventChannel` (named
  `baishunChannel` in the doc), or follow the doc's native modifications in
  `webview_flutter_android` to inject `NativeBridge` and an event sink.
- On iOS, use `WKWebView` with `WKUserContentController` script message handlers
  for `getConfig`, `destroy`, `gameRecharge`, `gameLoaded`.

**5. JS methods behavior summary**
- `getConfig(params)` (game -> app): app returns configuration JSON via the
  provided callback name (`jsCallback`) inside `params`.
- `destroy(params)` (game -> app): app should stop and unload the WebView and
  release resources.
- `gameRecharge(params)` (game -> app): open the app's in-app purchase or mall.
- `gameLoaded(params)` (game -> app): notify app that the game finished loading —
  useful to hide app loading spinners.
- `walletUpdate({...})` (app -> game): call this JS method when user balance
  changes to update the in-game display.

**6. Concurrency and error handling**
- `change_balance` must be idempotent/locked per user to avoid double-settlement.
- Error codes: 0 success; 1008 insufficient balance; 1003 signature error; see
  full list in the extracted text.

**7. Localization & language mapping**
- Language codes: 0 Chinese, 1 Traditional Chinese, 2 English, 3 Indonesian, ...
  (full table in the extracted text).

**8. Game package options**
- BAISHUN provides either remote URLs or ZIP packages. If a ZIP is provided,
  the app should download, unzip to sandbox path and load the local `index.html`
  with appropriate `allowUniversalAccessFromFileURLs` permissions.

**9. Quick implementation checklist (Flutter)**n+
1. Add `webview_flutter` dependency and platform-specific imports.
2. Ensure Android manifest has `INTERNET` and optional `usesCleartextTraffic`.
3. For Android, add native hook to inject `NativeBridge` and set up an
   EventChannel (`baishunChannel`) to receive game JS messages.
4. Instantiate `WebViewController` with `JavaScriptMode.unrestricted`, DOM
   storage enabled, media playback requires no gesture, and mixed content allowed.
5. Listen to the EventChannel or JavaScript channel to handle `getConfig`.
6. When `getConfig` is requested, build the config JSON (fields above), and
   inject it by calling the game's JS callback (e.g., `jsCallback(json)`).
7. When the game sends `destroy`, cleanly unload and hide the WebView.
8. Implement server endpoints to support `get_sstoken`, `get_user_info`, and
   `change_balance` with signature verification per BAISHUN documentation.

**10. Where to find details**
- Full, raw extracted documentation: [assets/BAISHUN_game_access.txt](assets/BAISHUN_game_access.txt)

If you want, I can:
- Patch the existing `lib/view/screens/room/room_screen.dart` to wire the
  exact `getConfig` payload and wire an EventChannel listener to send it when
  the game requests it.
- Or implement the Android native `NativeBridge`/EventChannel bits in the
  repo's `android` folder (requires rebuilding platform plugins).

---
Generated from the included BAISHUN PDF (version 1.2.8).
